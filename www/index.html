<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Prayer Times - London</title>
  <style>
    body {
      background: #2d9471;
      color: #fff;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      background: #ffcc00;
      color: #000;
      cursor: pointer;
      margin-bottom: 20px;
    }
    .row {
      display: block;
      margin-bottom: 15px;
      padding: 8px;
      border-radius: 6px;
    }
    .label {
      font-weight: bold;
      display: inline-block;
      width: 120px;
    }
    .value {
      display: inline-block;
    }
    .divider {
      border-bottom: 1px solid #fff;
      margin: 10px 0;
    }
    .highlight {
      background: #ffcc00;
      color: #000;
    }
  </style>
  <!-- Papa Parse CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h2>London Prayer Times</h2>

  <!-- Enable Azaan button -->
  <button id="enableAzan">Enable Azaan</button>

  <div id="row-fajr" class="row"><span class="label">Fajr:</span> <span id="fajr" class="value">Loading...</span></div>
  <div class="row"><span class="label">Fajr Jama'ah:</span> <span id="fajr-jamat" class="value">-</span></div>
  <div class="divider"></div>

  <div id="row-dhuhr" class="row"><span class="label">Dhuhr:</span> <span id="dhuhr" class="value">Loading...</span></div>
  <div class="row"><span class="label">Dhuhr Jama'ah:</span> <span id="dhuhr-jamat" class="value">-</span></div>
  <div class="divider"></div>

  <div id="row-asr" class="row"><span class="label">Asr:</span> <span id="asr" class="value">Loading...</span></div>
  <div class="row"><span class="label">Asr Jama'ah:</span> <span id="asr-jamat" class="value">-</span></div>
  <div class="divider"></div>

  <div id="row-maghrib" class="row"><span class="label">Maghrib:</span> <span id="maghrib" class="value">Loading...</span></div>
  <div class="row"><span class="label">Maghrib Jama'ah:</span> <span id="maghrib-jamat" class="value">-</span></div>
  <div class="divider"></div>

  <div id="row-isha" class="row"><span class="label">Isha:</span> <span id="isha" class="value">Loading...</span></div>
  <div class="row"><span class="label">Isha Jama'ah:</span> <span id="isha-jamat" class="value">-</span></div>

  <!-- Hosted Azaan audio -->
  <audio id="azaan" src="https://www.islamcan.com/audio/adhan/azan1.mp3" preload="auto"></audio>

  <script>
    var prayerTimes = {};
    var prayerOrder = ["fajr", "dhuhr", "asr", "maghrib", "isha"];
    var azaanPlayed = {};
    var azaanEnabled = false;
    var lastDate = null;
    var csvData = [];

    // Load CSV and process today's timings
    function loadPrayerTimesFromCSV() {
      Papa.parse('csv1563040081.csv', {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          csvData = results.data;
          setTodaysPrayerTimes();
        }
      });
    }

    function setTodaysPrayerTimes() {
      var now = new Date();
      // Format: "DD-MM-YYYY"
      var day = now.getDate().toString().padStart(2, '0');
      var month = (now.getMonth() + 1).toString().padStart(2, '0');
      var year = now.getFullYear();
      var dateStr = `${day}-${month}-${year}`;

      // Find row with today's date
      var todayRow = csvData.find(row => row['date.gregorian.date'] === dateStr);
      if (!todayRow) {
        document.getElementById("fajr").innerHTML = "Not found";
        document.getElementById("dhuhr").innerHTML = "Not found";
        document.getElementById("asr").innerHTML = "Not found";
        document.getElementById("maghrib").innerHTML = "Not found";
        document.getElementById("isha").innerHTML = "Not found";
        return;
      }

      // Remove " (GMT)" or " (BST)" from times
      function cleanTime(t) {
        return t.replace(/\s*\([^)]+\)/, "");
      }

      prayerTimes = {
        fajr: cleanTime(todayRow["timings.Fajr"]),
        dhuhr: cleanTime(todayRow["timings.Dhuhr"]),
        asr: cleanTime(todayRow["timings.Asr"]),
        maghrib: cleanTime(todayRow["timings.Maghrib"]),
        isha: cleanTime(todayRow["timings.Isha"])
      };

      document.getElementById("fajr").innerHTML = prayerTimes.fajr;
      document.getElementById("dhuhr").innerHTML = prayerTimes.dhuhr;
      document.getElementById("asr").innerHTML = prayerTimes.asr;
      document.getElementById("maghrib").innerHTML = prayerTimes.maghrib;
      document.getElementById("isha").innerHTML = prayerTimes.isha;

      lastDate = now.getDate();
      azaanPlayed = {};
    }

    function parseTime(timeStr) {
      var parts = timeStr.split(":");
      if (parts.length < 2) return null;
      var d = new Date();
      d.setSeconds(0);
      d.setMilliseconds(0);
      d.setHours(parseInt(parts[0], 10));
      d.setMinutes(parseInt(parts[1], 10));
      return d;
    }

    function highlightNextPrayer() {
      for (var i = 0; i < prayerOrder.length; i++) {
        var row = document.getElementById("row-" + prayerOrder[i]);
        if (row) row.className = "row";
      }

      var now = new Date();
      var nextPrayer = null;

      for (var j = 0; j < prayerOrder.length; j++) {
        var prayer = prayerOrder[j];
        var t = parseTime(prayerTimes[prayer]);
        if (t && t.getTime() > now.getTime()) {
          nextPrayer = prayer;
          break;
        }
      }
      if (!nextPrayer) nextPrayer = "fajr";
      var rowNext = document.getElementById("row-" + nextPrayer);
      if (rowNext) rowNext.className = "row highlight";
    }

    function checkAzaan() {
      if (!azaanEnabled) return;
      var now = new Date();
      for (var i = 0; i < prayerOrder.length; i++) {
        var prayer = prayerOrder[i];
        var t = parseTime(prayerTimes[prayer]);
        if (t) {
          var diff = Math.abs(now.getTime() - t.getTime());
          if (diff < 60000 && !azaanPlayed[prayer]) {
            document.getElementById("azaan").play();
            azaanPlayed[prayer] = true;
          }
        }
      }
    }

    // Main
    loadPrayerTimesFromCSV();

    setInterval(function() {
      var today = new Date().getDate();
      if (today !== lastDate) setTodaysPrayerTimes();
      highlightNextPrayer();
      checkAzaan();
    }, 60000);

    setTimeout(function() {
      highlightNextPrayer();
      checkAzaan();
    }, 5000);

    document.getElementById("enableAzan").addEventListener("click", function() {
      azaanEnabled = true;
      this.style.display = "none";
      alert("Azaan enabled! Audio will play at prayer times.");
    });
  </script>
</body>
</html>
